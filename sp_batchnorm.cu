#include <cuda_runtime.h>
#include <cudnn.h>
#include <cstdio>
#include <iostream>

float* malloc_sync_to_device(float* h_ptr, int len) {
  float* d_ptr;
  cudaMalloc(&d_ptr, sizeof(float)*len);
  cudaMemcpy(d_ptr, h_ptr, sizeof(float)*len, cudaMemcpyHostToDevice);
  return d_ptr;
}

__global__ void print(float* ptr, int64_t len) {
  if(threadIdx.x==0) {
    printf("%d\n",len);
    for(int64_t i=0;i<len;i++){
      printf(",%.50f",ptr[i]);
    }
    printf("\n");
  }
}

int main() {
  printf("\ncudnn version:%d.%d.%d\n", CUDNN_MAJOR, CUDNN_MINOR, CUDNN_PATCHLEVEL);
  // int dims[5] = {2,3,8,8,1};
  // int strides[5] = {192,64,8,1,1};

  // (n*h*w, c)
  int dims[5] = {128,3,1,1,1};
  int strides[5] = {3,1,1,1,1};

  float h_sp_xData[384];
  float h_alphaDataDiff[1] = {1.0};
  float h_betaDataDiff[1] = {0.0};
  float h_alphaParamDiff[1] = {1.0};
  float h_betaParamDiff[1] = {0.0};
  float h_xData[384]={0.00097627006471157073974609375000000000000000000000,0.00089766364544630050659179687500000000000000000000,-0.00124825572129338979721069335937500000000000000000,-0.00233116955496370792388916015625000000000000000000,0.00136089127045124769210815429687500000000000000000,-0.00825741421431303024291992187500000000000000000000,0.00556313479319214820861816406250000000000000000000,0.00598317105323076248168945312500000000000000000000,-0.00763451168313622474670410156250000000000000000000,0.00889337807893753051757812500000000000000000000000,-0.00470888754352927207946777343750000000000000000000,0.00136867898982018232345581054687500000000000000000,0.00224191439338028430938720703125000000000000000000,0.00363640603609383106231689453125000000000000000000,0.00395262381061911582946777343750000000000000000000,0.00341275730170309543609619140625000000000000000000,-0.00369143299758434295654296875000000000000000000000,-0.00122796976938843727111816406250000000000000000000,-0.00582246482372283935546875000000000000000000000000,-0.00493416795507073402404785156250000000000000000000,-0.00682060839608311653137207031250000000000000000000,-0.00723634101450443267822265625000000000000000000000,0.00641986448317766189575195312500000000000000000000,-0.00807803217321634292602539062500000000000000000000,0.00953522138297557830810546875000000000000000000000,-0.00921624433249235153198242187500000000000000000000,-0.00407719612121582031250000000000000000000000000000,-0.00171474006492644548416137695312500000000000000000,0.00133202911820262670516967773437500000000000000000,-0.00812118966132402420043945312500000000000000000000,-0.00362862087786197662353515625000000000000000000000,0.00432654423639178276062011718750000000000000000000,0.00173025869298726320266723632812500000000000000000,-0.00990609079599380493164062500000000000000000000000,0.00470388028770685195922851562500000000000000000000,0.00152314663864672183990478515625000000000000000000,-0.00553836720064282417297363281250000000000000000000,0.00692817335948348045349121093750000000000000000000,0.00627595651894807815551757812500000000000000000000,0.00162545742932707071304321289062500000000000000000,0.00450508575886487960815429687500000000000000000000,0.00287980400025844573974609375000000000000000000000,-0.00961613561958074569702148437500000000000000000000,-0.00419844780117273330688476562500000000000000000000,-0.00729051884263753890991210937500000000000000000000,0.00181745528243482112884521484375000000000000000000,0.00304206530563533306121826171875000000000000000000,-0.00264876266010105609893798828125000000000000000000,0.00612387992441654205322265625000000000000000000000,0.00838965270668268203735351562500000000000000000000,-0.00701103406026959419250488281250000000000000000000,0.00231119128875434398651123046875000000000000000000,0.00614637928083539009094238281250000000000000000000,-0.00861665979027748107910156250000000000000000000000,0.00444111181423068046569824218750000000000000000000,0.00711606675758957862854003906250000000000000000000,0.00459981104359030723571777343750000000000000000000,-0.00891324039548635482788085937500000000000000000000,0.00587395392358303070068359375000000000000000000000,0.00856162607669830322265625000000000000000000000000,-0.00670611672103404998779296875000000000000000000000,-0.00524214375764131546020507812500000000000000000000,0.00071265606675297021865844726562500000000000000000,-0.00376110011711716651916503906250000000000000000000,0.00430378736928105354309082031250000000000000000000,-0.00152690405957400798797607421875000000000000000000,0.00783545989543199539184570312500000000000000000000,0.00583450077101588249206542968750000000000000000000,0.00851193256676197052001953125000000000000000000000,-0.00959563162177801132202148437500000000000000000000,0.00740024307742714881896972656250000000000000000000,-0.00077041273470968008041381835937500000000000000000,0.00279842037707567214965820312500000000000000000000,0.00043696642387658357620239257812500000000000000000,0.00548467366024851799011230468750000000000000000000,-0.00962420366704463958740234375000000000000000000000,0.00233867997303605079650878906250000000000000000000,-0.00280984188430011272430419921875000000000000000000,-0.00879549048840999603271484375000000000000000000000,-0.00579234864562749862670898437500000000000000000000,-0.00272578466683626174926757812500000000000000000000,0.00976747646927833557128906250000000000000000000000,-0.00677380943670868873596191406250000000000000000000,-0.00067378452513366937637329101562500000000000000000,-0.00779249705374240875244140625000000000000000000000,-0.00606835260987281799316406250000000000000000000000,-0.00805797427892684936523437500000000000000000000000,0.00952918920665979385375976562500000000000000000000,0.00209691049531102180480957031250000000000000000000,-0.00434386078268289566040039062500000000000000000000,-0.00762544572353363037109375000000000000000000000000,-0.00871704984456300735473632812500000000000000000000,-0.00469221035018563270568847656250000000000000000000,0.00151892995927482843399047851562500000000000000000,0.00334820756688714027404785156250000000000000000000,-0.00421187793835997581481933593750000000000000000000,-0.00959784910082817077636718750000000000000000000000,0.00355633068829774856567382812500000000000000000000,0.00924377050250768661499023437500000000000000000000,0.00184083858039230108261108398437500000000000000000,0.00905498024076223373413085937500000000000000000000,0.00398958567529916763305664062500000000000000000000,-0.00206988514401018619537353515625000000000000000000,0.00763470726087689399719238281250000000000000000000,0.00002648763802426401525735855102539062500000000000,-0.00152289902325719594955444335937500000000000000000,-0.00396850379183888435363769531250000000000000000000,0.00236030854284763336181640625000000000000000000000,-0.00403435342013835906982421875000000000000000000000,0.00148650503251701593399047851562500000000000000000,-0.00137163128238171339035034179687500000000000000000,-0.00128270150162279605865478515625000000000000000000,0.00407777167856693267822265625000000000000000000000,0.00428482610732316970825195312500000000000000000000,0.00736252125352621078491210937500000000000000000000,-0.00752360047772526741027832031250000000000000000000,0.00138201471418142318725585937500000000000000000000,0.00394857535138726234436035156250000000000000000000,0.00732764648273587226867675781250000000000000000000,-0.00976571813225746154785156250000000000000000000000,-0.00656740646809339523315429687500000000000000000000,-0.00600006943568587303161621093750000000000000000000,-0.00552150607109069824218750000000000000000000000000,0.00408828817307949066162109375000000000000000000000,0.00242956797592341899871826171875000000000000000000,0.00868428032845258712768554687500000000000000000000,0.00179819948971271514892578125000000000000000000000,-0.00203557871282100677490234375000000000000000000000,0.00205526757054030895233154296875000000000000000000,0.00291788228787481784820556640625000000000000000000,0.00927325524389743804931640625000000000000000000000,0.00057789840502664446830749511718750000000000000000,-0.00857927929610013961791992187500000000000000000000,0.00665239710360765457153320312500000000000000000000,0.00957236718386411666870117187500000000000000000000,0.00561058335006237030029296875000000000000000000000,-0.00713293440639972686767578125000000000000000000000,-0.00170676119159907102584838867187500000000000000000,-0.00087699334835633635520935058593750000000000000000,0.00235270988196134567260742187500000000000000000000,0.00887496117502450942993164062500000000000000000000,-0.00125936092808842658996582031250000000000000000000,0.00333533436059951782226562500000000000000000000000,-0.00742147397249937057495117187500000000000000000000,0.00140393537003546953201293945312500000000000000000,-0.00795910414308309555053710937500000000000000000000,0.00306216650642454624176025390625000000000000000000,-0.00511148804798722267150878906250000000000000000000,0.00312659167684614658355712890625000000000000000000,-0.00262549659237265586853027343750000000000000000000,0.00675889803096652030944824218750000000000000000000,-0.00062697596149519085884094238281250000000000000000,0.00478527136147022247314453125000000000000000000000,-0.00759606854990124702453613281250000000000000000000,-0.00364033645018935203552246093750000000000000000000,0.00384944234974682331085205078125000000000000000000,0.00046496107825078070163726806640625000000000000000,0.00858592428267002105712890625000000000000000000000,-0.00736404256895184516906738281250000000000000000000,-0.00633617257699370384216308593750000000000000000000,0.00657880073413252830505371093750000000000000000000,-0.00459984038025140762329101562500000000000000000000,-0.00502493698149919509887695312500000000000000000000,0.00144503812771290540695190429687500000000000000000,-0.00105749245267361402511596679687500000000000000000,-0.00405126111581921577453613281250000000000000000000,0.00762206409126520156860351562500000000000000000000,0.00385063188150525093078613281250000000000000000000,0.00912167225033044815063476562500000000000000000000,0.00212786439806222915649414062500000000000000000000,0.00320347072556614875793457031250000000000000000000,-0.00142462598159909248352050781250000000000000000000,0.00139929819852113723754882812500000000000000000000,0.00306401634588837623596191406250000000000000000000,0.00793093163520097732543945312500000000000000000000,0.00783846713602542877197265625000000000000000000000,-0.00799546204507350921630859375000000000000000000000,0.00997694022953510284423828125000000000000000000000,-0.00675014127045869827270507812500000000000000000000,0.00696016475558280944824218750000000000000000000000,-0.00185633404180407524108886718750000000000000000000,-0.00092914636479690670967102050781250000000000000000,0.00951043050736188888549804687500000000000000000000,-0.00280043878592550754547119140625000000000000000000,0.00042073213262483477592468261718750000000000000000,-0.00962956435978412628173828125000000000000000000000,-0.00309296627528965473175048828125000000000000000000,-0.00936322100460529327392578125000000000000000000000,0.00154457171447575092315673828125000000000000000000,0.00227931910194456577301025390625000000000000000000,0.00460244063287973403930664062500000000000000000000,-0.00580312497913837432861328125000000000000000000000,-0.00627613998949527740478515625000000000000000000000,-0.00019082383369095623493194580078125000000000000000,-0.00883941724896430969238281250000000000000000000000,0.00392686994746327400207519531250000000000000000000,-0.00950642582029104232788085937500000000000000000000,-0.00092606310499832034111022949218750000000000000000,0.00980677921324968338012695312500000000000000000000,-0.00473355269059538841247558593750000000000000000000,-0.00359965697862207889556884765625000000000000000000,0.00662096915766596794128417968750000000000000000000,-0.00452915951609611511230468750000000000000000000000,0.00905583333224058151245117187500000000000000000000,0.00894741155207157135009765625000000000000000000000,-0.00573376053944230079650878906250000000000000000000,-0.00585059868171811103820800781250000000000000000000,-0.00072849151911213994026184082031250000000000000000,0.00727711198851466178894042968750000000000000000000,-0.00735863810405135154724121093750000000000000000000,0.00130842626094818115234375000000000000000000000000,-0.00023887438874226063489913940429687500000000000000,0.00530650513246655464172363281250000000000000000000,-0.00833155121654272079467773437500000000000000000000,0.00923872739076614379882812500000000000000000000000,-0.00799412094056606292724609375000000000000000000000,0.00339833088219165802001953125000000000000000000000,0.00172820338048040866851806640625000000000000000000,0.00954990275204181671142578125000000000000000000000,0.00923140347003936767578125000000000000000000000000,0.00882755406200885772705078125000000000000000000000,0.00748575944453477859497070312500000000000000000000,0.00235753390006721019744873046875000000000000000000,-0.00703718280419707298278808593750000000000000000000,-0.00005217269062995910644531250000000000000000000000,-0.00726199476048350334167480468750000000000000000000,0.00022637964866589754819869995117187500000000000000,0.00724383024498820304870605468750000000000000000000,0.00813111010938882827758789062500000000000000000000,-0.00837797205895185470581054687500000000000000000000,-0.00735024735331535339355468750000000000000000000000,-0.00977145042270421981811523437500000000000000000000,-0.00840955879539251327514648437500000000000000000000,-0.00509265577420592308044433593750000000000000000000,0.00721102347597479820251464843750000000000000000000,-0.00737034389749169349670410156250000000000000000000,-0.00475763715803623199462890625000000000000000000000,0.00391250895336270332336425781250000000000000000000,-0.00637698080390691757202148437500000000000000000000,0.00393994478508830070495605468750000000000000000000,-0.00481154862791299819946289062500000000000000000000,-0.00454356195405125617980957031250000000000000000000,-0.00080288230674341320991516113281250000000000000000,-0.00846087094396352767944335937500000000000000000000,0.00155085895676165819168090820312500000000000000000,-0.00929275155067443847656250000000000000000000000000,0.00072354992153123021125793457031250000000000000000,-0.00742278853431344032287597656250000000000000000000,-0.00625738222151994705200195312500000000000000000000,-0.00086177157936617732048034667968750000000000000000,0.00448335288092494010925292968750000000000000000000,0.00380050041712820529937744140625000000000000000000,0.00513557298108935356140136718750000000000000000000,-0.00678922375664114952087402343750000000000000000000,-0.00083722342969849705696105957031250000000000000000,-0.00085553096141666173934936523437500000000000000000,0.00888744741678237915039062500000000000000000000000,-0.00545170763507485389709472656250000000000000000000,-0.00131166749633848667144775390625000000000000000000,-0.00244496320374310016632080078125000000000000000000,-0.00865500699728727340698242187500000000000000000000,0.00073158420855179429054260253906250000000000000000,-0.00566206034272909164428710937500000000000000000000,-0.00958697963505983352661132812500000000000000000000,-0.00233072205446660518646240234375000000000000000000,0.00257963687181472778320312500000000000000000000000,0.00596093665808439254760742187500000000000000000000,0.00374976545572280883789062500000000000000000000000,0.00461711594834923744201660156250000000000000000000,0.00036401426768861711025238037109375000000000000000,-0.00150629063136875629425048828125000000000000000000,-0.00444742571562528610229492187500000000000000000000,-0.00764936301857233047485351562500000000000000000000,0.00433719344437122344970703125000000000000000000000,-0.00633440306410193443298339843750000000000000000000,-0.00288774515502154827117919921875000000000000000000,0.00497327232733368873596191406250000000000000000000,0.00104384939186275005340576171875000000000000000000,-0.00415704958140850067138671875000000000000000000000,-0.00967140775173902511596679687500000000000000000000,0.00570305809378623962402343750000000000000000000000,-0.00872089434415102005004882812500000000000000000000,0.00753010483458638191223144531250000000000000000000,-0.00536596728488802909851074218750000000000000000000,0.00598405161872506141662597656250000000000000000000,-0.00413959426805377006530761718750000000000000000000,-0.00973526295274496078491210937500000000000000000000,0.00963658746331930160522460937500000000000000000000,0.00278945034369826316833496093750000000000000000000,0.00644235452637076377868652343750000000000000000000,-0.00551365921273827552795410156250000000000000000000,0.00945839006453752517700195312500000000000000000000,0.00548094650730490684509277343750000000000000000000,-0.00185517652425915002822875976562500000000000000000,-0.00893145613372325897216796875000000000000000000000,0.00541161512956023216247558593750000000000000000000,-0.00820793956518173217773437500000000000000000000000,-0.00158921070396900177001953125000000000000000000000,0.00454088533297181129455566406250000000000000000000,-0.00889251381158828735351562500000000000000000000000,-0.00087718863505870103836059570312500000000000000000,-0.00432962318882346153259277343750000000000000000000,0.00577091006562113761901855468750000000000000000000,0.00557390786707401275634765625000000000000000000000,-0.00252373726107180118560791015625000000000000000000,-0.00258294399827718734741210937500000000000000000000,-0.00910775363445281982421875000000000000000000000000,0.00037670298479497432708740234375000000000000000000,0.00918866693973541259765625000000000000000000000000,-0.00139195122756063938140869140625000000000000000000,0.00362785020843148231506347656250000000000000000000,-0.00214648642577230930328369140625000000000000000000,0.00807967875152826309204101562500000000000000000000,0.00764082837849855422973632812500000000000000000000,-0.00201949360780417919158935546875000000000000000000,0.00399244111031293869018554687500000000000000000000,0.00272122118622064590454101562500000000000000000000,0.00592782953754067420959472656250000000000000000000,0.00181968335527926683425903320312500000000000000000,0.00903748907148838043212890625000000000000000000000,0.00479101575911045074462890625000000000000000000000,-0.00491287047043442726135253906250000000000000000000,-0.00376408244483172893524169921875000000000000000000,-0.00640792632475495338439941406250000000000000000000,0.00358785549178719520568847656250000000000000000000,0.00793342571705579757690429687500000000000000000000,0.00326156406663358211517333984375000000000000000000,0.00516757322475314140319824218750000000000000000000,0.00176634232047945261001586914062500000000000000000,0.00745301321148872375488281250000000000000000000000,-0.00628728093579411506652832031250000000000000000000,-0.00568984635174274444580078125000000000000000000000,-0.00492116715759038925170898437500000000000000000000,-0.00948674604296684265136718750000000000000000000000,-0.00251660030335187911987304687500000000000000000000,0.00173568690661340951919555664062500000000000000000,0.00034758212859742343425750732421875000000000000000,-0.00207880605012178421020507812500000000000000000000,-0.00710304500535130500793457031250000000000000000000,0.00880863890051841735839843750000000000000000000000,0.00807439442723989486694335937500000000000000000000,0.00168952136300504207611083984375000000000000000000,-0.00518342433497309684753417968750000000000000000000,0.00859058648347854614257812500000000000000000000000,-0.00436539808288216590881347656250000000000000000000,-0.00028744808514602482318878173828125000000000000000,-0.00323682092130184173583984375000000000000000000000,0.00898637622594833374023437500000000000000000000000,0.00260895863175392150878906250000000000000000000000,0.00697887130081653594970703125000000000000000000000,-0.00305532966740429401397705078125000000000000000000,-0.00043259386438876390457153320312500000000000000000,-0.00262830778956413269042968750000000000000000000000,-0.00620304187759757041931152343750000000000000000000,-0.00804311037063598632812500000000000000000000000000,0.00921669322997331619262695312500000000000000000000,-0.00333709688857197761535644531250000000000000000000,-0.00535531714558601379394531250000000000000000000000,0.00451188720762729644775390625000000000000000000000,-0.00706106703728437423706054687500000000000000000000,0.00344095611944794654846191406250000000000000000000,0.00114737579133361577987670898437500000000000000000,-0.00459344172850251197814941406250000000000000000000,-0.00396802742034196853637695312500000000000000000000,0.00366562674753367900848388671875000000000000000000,-0.00240146089345216751098632812500000000000000000000,-0.00886303838342428207397460937500000000000000000000,0.00554815120995044708251953125000000000000000000000,0.00175199273508042097091674804687500000000000000000,-0.00605891458690166473388671875000000000000000000000,0.00599591759964823722839355468750000000000000000000,-0.00386379798874258995056152343750000000000000000000,0.00291140493936836719512939453125000000000000000000,0.00020033704640809446573257446289062500000000000000,-0.00444807810708880424499511718750000000000000000000,0.00912811420857906341552734375000000000000000000000,0.00087611901108175516128540039062500000000000000000,-0.00082792073953896760940551757812500000000000000000,0.00808088760823011398315429687500000000000000000000,-0.00344559201039373874664306640625000000000000000000,-0.00519959442317485809326171875000000000000000000000,0.00918333232402801513671875000000000000000000000000,0.00715445308014750480651855468750000000000000000000,0.00151502329390496015548706054687500000000000000000};
  float h_dyData[384]={1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000,1.00000000000000000000000000000000000000000000000000};

  // n*h*w, c -> ((n,h,w),c)
  for(int n=0;n<2;n++) {
    for(int h=0;h<8;h++) {
      for(int w=0;w<8;w++) {
        for(int c=0;c<3;c++) {
          h_sp_xData[(n*64+h*8+w)*3+c] = h_xData[n*192+c*64+h*8+w];
        }
      }
    }
  }

  float h_bnScaleData[3] = {1.0000000,1.0000000,1.0000000};
  double epsilon = 0.000010;
  float h_savedMean[3] = {-0.00051714654546231031417846679687500000000000000000,-0.00001659977715462446212768554687500000000000000000,0.00039221986662596464157104492187500000000000000000};
  float h_savedInvVariance[3] = {149.16923522949218750000000000000000000000000000000000,151.64489746093750000000000000000000000000000000000000,157.59590148925781250000000000000000000000000000000000};
  // float* d_xData = malloc_sync_to_device(h_xData, 384);
  float* d_xData = malloc_sync_to_device(h_sp_xData, 384);
  float* d_dyData = malloc_sync_to_device(h_dyData, 384);
  float* d_bnScaleData = malloc_sync_to_device(h_bnScaleData, 3);
  float* d_savedMean = malloc_sync_to_device(h_savedMean, 3);
  float* d_savedInvVariance = malloc_sync_to_device(h_savedInvVariance, 3);
  int reserveSpaceSizeInBytes = 0;
  cudnnTensorDescriptor_t data_desc_;
  cudnnTensorDescriptor_t bn_param_desc_;
  cudnnBatchNormMode_t mode_;
  cudnnCreateTensorDescriptor(&data_desc_);
  cudnnCreateTensorDescriptor(&bn_param_desc_);
  // mode_ = CUDNN_BATCHNORM_SPATIAL;
  mode_ = CUDNN_BATCHNORM_PER_ACTIVATION;
  cudnnSetTensorNdDescriptor(data_desc_,
                             CUDNN_DATA_FLOAT,
                             4,
                             dims,
                             strides);
  cudnnDeriveBNTensorDescriptor(bn_param_desc_, data_desc_, mode_);
  cudnnHandle_t handle_;
  cudnnCreate(&handle_);
  size_t workspace_size = 0;
  void *workspace_ptr = nullptr;
  float* d_dxData;
  float* d_dBnScaleData;
  float* d_dBnBiasData;
  cudaMalloc(&d_dxData, sizeof(float)*384);
  cudaMalloc(&d_dBnScaleData, sizeof(float)*3);
  cudaMalloc(&d_dBnBiasData, sizeof(float)*3);

  cudnnGetBatchNormalizationBackwardExWorkspaceSize(
                /*handle=*/handle_,
                /*mode=*/mode_,
                /*bnIps=*/CUDNN_BATCHNORM_OPS_BN,
                /*xDesc=*/data_desc_,
                /*yDesc=*/data_desc_,
                /*dyDesc=*/data_desc_,
                /*dzDesc=*/nullptr,
                /*dxDesc=*/data_desc_,
                /*bnScaleBiasMeanVarDesc=*/bn_param_desc_,
                /*activationDesc=*/nullptr,
                /*sizeInBytes=*/&workspace_size);

  cudnnBatchNormalizationBackwardEx(
                /*handle=*/handle_,
                /*mode=*/mode_,
                /*bnOps=*/CUDNN_BATCHNORM_OPS_BN,
                /*alphaDataDiff=*/h_alphaDataDiff,
                /*betaDataDiff=*/h_betaDataDiff,
                /*alphaParamDiff=*/h_alphaParamDiff,
                /*betaParamDiff=*/h_betaParamDiff,
                /*xDesc=*/data_desc_,
                /*xData=*/d_xData,
                /*yDesc=*/nullptr,
                /*yData=*/nullptr,
                /*dyDesc=*/data_desc_,
                /*dyData=*/d_dyData,
                /*dzDesc=*/nullptr,
                /*dzData=*/nullptr,
                /*dxDesc=*/data_desc_,
                /*dxData=*/d_dxData,
                /*dBnScaleBiasDesc=*/bn_param_desc_,
                /*bnScaleData=*/d_bnScaleData,
                /*bnBiasData=*/nullptr,
                /*dBnScaleData=*/
                d_dBnScaleData,
                /*dBnBiasData=*/
                d_dBnBiasData,
                /*epsilon=*/epsilon,
                /*savedMean=*/d_savedMean,
                /*savedInvVariance=*/d_savedInvVariance,
                /*activationDesc=*/nullptr,
                /*workspace=*/workspace_ptr,
                /*workSpaceSizeInBytes=*/workspace_size,
                /*reserveSpace=*/
                nullptr,
                /*reserveSpaceSizeInBytes=*/reserveSpaceSizeInBytes);
  cudaDeviceSynchronize();
  printf("\nd_dxData\n");
  cudaDeviceSynchronize();
  print<<<1,1>>>(d_dxData, 384);
  cudaDeviceSynchronize();
}